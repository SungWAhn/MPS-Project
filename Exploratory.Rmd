---
title: "MPS Project"
author: "Sung-Woo Ahn Wanwen Gu Yvonne Liu Xinyue Chen"
date: "March 4, 2019"
output: 
  html_document:
    highlight: pygments
    theme: cosmo
---

<style type="text/css">

body{ /* Normal  */
      font-size: 18px;
  }

</style>

# Import dataset
```{r warning=FALSE, message=FALSE, echo=FALSE}
library(knitr)
library(readr)
library(data.table)
library(bit64)
library(Rmpfr)
library(tidyverse)
library(plyr)
library(ggmosaic)
library(ggmap)
library(plotly)
library(kableExtra)
library(readxl)
options(kableExtra.latex.load_packages = FALSE)
knit_hooks$set(document = function(x) {
  sub('\\usepackage[]{color}', '\\usepackage[]{xcolor}', x, fixed = TRUE)
})

```

```{r}
train <- fread("train.csv", header = T)
setDT(train[,-1])
```

```{r}
# Plain read.csv can take a while. fread from data.table library is much more efficient
app_labels <- fread('app_labels.csv', header = T)
labelcategory <- fread('label_standardized categories.csv', header = T)
labelsdat <- merge(x = app_labels, y = labelcategory, by = 'label_id', all.x = T)


response <- train[, list(device_id, gender, age, group, app_id)]

uniquelabels <- labelsdat %>%
  arrange(app_id) %>%
  group_by(app_id, category) %>%
  distinct(category)

labeltrain <- merge(x = response, y = uniquelabels, by = 'app_id', all.x = T, allow.cartesian = T)

```

## Exploratory Analysis

### Missing Values

Location Data
```{r}
inva_locations<-sum(train$longitude == 1 | train$longitude ==0 | train$latitude ==1 | train$latitude ==0)/length(train$longitude)
```
58% of the location data is invalid.

Phone Brand and Model Data
```{r}
dim(train[is.na(train$phone_brand)])
dim(train[is.na(train$phone_brand)])[1]/dim(train)[1]*100

dim(train[is.na(train$device_model)])
dim(train[is.na(train$device_model)])[1]/dim(train)[1]*100
```
Almost 100% of phonebrands and phone models are missing

Is_Installed and Is_Active Data
```{r}
dim(train[is.na(train$is_installed)])
dim(train[is.na(train$is_installed)])[1]/dim(train)[1]*100

dim(train[is.na(train$is_active)])
dim(train[is.na(train$is_active)])[1]/dim(train)[1]*100
```

```{r}
dim(train[is.na(train$app_id)])
dim(train[is.na(train$app_id)])[1]/dim(train)[1]*100

dim(train[is.na(train$app_id) | app_id == 0])
dim(train[is.na(train$app_id)])[1]/dim(train)[1]*100
```

No missing values in these predictors
```{r}
dim(train[is.na(train$timestamp)])
dim(train[is.na(train$event_id)])
dim(train[is.na(train$device_id)])
dim(train[is.na(train$gender)])
dim(train[is.na(train$age)])
dim(train[is.na(train$group)])
```

#Gender Distribution
```{r}
ggplot(data=train,aes(x=gender,fill=gender))+
  geom_bar(stat="count")+
  ggtitle("Gender Distribution")
```

#Age-Gender Distribution
```{r}
ggplot(data=train,aes(x=age,fill=gender))+
  geom_histogram(stat="count")+
  ggtitle("Age-Gender Distribution")
```
#Group Distribution
```{r}
ggplot(data=train,aes(x=group,fill=gender))+
  geom_bar(stat="count")+
  ggtitle("Group Distribution")
```
#Is_Active Distribution
```{r}
ggplot(data=train,aes(x=factor(is_active)))+
  geom_bar(stat="count",fill="steelblue")+
  ggtitle("Is_Active Distribution")
```

#Phone Brand Distribution
```{r fig.width=13}
# Find phonebrand count
phonebrandsorted <- train %>%
  select(phone_brand) %>%
  group_by(phone_brand) %>%
  dplyr::summarize(count = n()) %>%
  filter(is.na(phone_brand) == 0) %>%
  arrange(desc(count))

ggplot(data = phonebrandsorted, aes(x = reorder(phone_brand, -count), y = count, fill=count)) +
  geom_bar(stat="identity") +
  labs(x = 'Phone Brands', y = 'Count', Main = 'Phone Brand Count')
```

App category counts
```{r fig.width=15}
# Find label count
labelcount <- uniquelabels %>%
  select(category) %>%
  group_by(category) %>%
  dplyr::summarize(count = n()) %>%
  arrange(desc(count))

ggplot(data = labelcount, aes(x = reorder(category,-count),y=count,fill = count)) +
  geom_bar(stat="identity") +
  theme(axis.text.x = element_text(angle = 60, hjust = 1))
  labs(x = 'Phone Brands', y = 'Count', Main = 'Phone Brand Count')
```

Event_id distribution
```{r}
train2 <- train
require(data.table)
setDT(train2)[, count := uniqueN(event_id), by = device_id]
count_event = train2[, list(device_id, group,count)]
count_event2 = unique(count_event)  # length 23309




grp <- c('F23-','F24-26','F27-28','F29-32','F33-42','F43+','M22-','M23-26','M27-28','M29-31','M32-38','M39+')
len <- length(grp)
grp_num <- rep(0, len)
grp_sum <- rep(0, len)
grp_mean <- rep(0, len)
grp_median <- rep(0, len)
grp_max <- rep(0, len)
grp_min <- rep(0, len)
for (i in 1:len){
  thisgroup <- count_event2[group==grp[i]]
  grp_num[i] <- dim(thisgroup)[1]
  grp_sum[i] <- sum(thisgroup$count)
  grp_mean[i] <- mean(thisgroup$count)
  grp_median[i] <- median(thisgroup$count)
  grp_max[i] <- max(thisgroup$count)
  grp_min[i] <- min(thisgroup$count)
}
barplot(grp_sum,names.arg=grp, las=2)
barplot(grp_num,names.arg=grp, las=2)
barplot(grp_mean,names.arg=grp, las=2)
grp_event <- data.frame('group'=grp,'number'=grp_num,'sum'=grp_sum,'mean'=grp_mean,'median'=grp_median,
                        'max'=grp_max,'min'=grp_min)
grp_event

```

Relationship of App Usage Count with Gender & Age
```{r}
# Count number of app uses each group category has
m39 <- dim(train[which(train$group == 'M39+')])[1]
m32.38<- dim(train[which(train$group == 'M32-38')])[1]
m29.31<- dim(train[which(train$group == 'M29-31')])[1]
m27.28 <- dim(train[which(train$group == 'M27-28')])[1]
m23.26 <- dim(train[which(train$group == 'M23-26')])[1]
m22 <- dim(train[which(train$group == 'M22-')])[1]
f43 <- dim(train[which(train$group == 'F43+')])[1]
f33.42 <- dim(train[which(train$group == 'F33-42')])[1]
f29.32 <- dim(train[which(train$group == 'F29-32')])[1]
f27.28 <- dim(train[which(train$group == 'F27-28')])[1]
f24.26 <- dim(train[which(train$group == 'F24-26')])[1]
f23 <- dim(train[which(train$group == 'F23-')])[1]

groupcts <- data.frame('category' = c('M39+', 'M32-38', 'M29-31', 'M27-28', 'M23-26', 'M22-', 'F43+', 'F33-42', 'F29-32', 'F27-28', 'F24-26', 'F23-'), 'counts' = c(m39, m32.38, m29.31, m27.28, m23.26, m22, f43, f33.42, f29.32, f27.28, f24.26, f23))


# Simpler with dplyr
groupcts2 <- train %>%
  group_by(group) %>%
  dplyr::summarise(count = n()) %>%
  mutate(proportion = 100*count/sum(count))
```

```{r results='asis', echo=FALSE}
groupcts2 %>%
  mutate(
    count = cell_spec(count, color = ifelse(count == max(count[1:6]) | count == max(count[7:12]), "blue", "black")),
    proportion = cell_spec(proportion, color = ifelse(proportion == max(proportion[1:6]) | proportion == max(proportion[7:12]), "blue", "black"))
  ) %>%
kable(escape = F, caption = 'App Usage Count by Group') %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "responsive"), full_width = F)
```

Males seem to be more active than females, but this is probably due to the fact that there are more males than females:
```{r}
malecount <- sum(groupcts[1:6,2])
femalecount <- sum(groupcts[7:12,2])
percentage <- (malecount-femalecount)/malecount
percentage
```
There are 63% more males than females in the dataset

In the female category, ages 33-42 are most active, while for males, ages 32-38 are most active.

A clearer picture of App Usage
```{r}
# Dplyr way
groupgendercts <- train %>%
  select(gender, age) %>%
  mutate(agecat = case_when(age <= 23 ~ "23-",
                            age > 23 & age <= 26 ~ "24-26",
                            age > 26 & age <= 28 ~ "27-28",
                            age > 28 & age <= 32 ~ "29-32",
                            age > 32 & age <= 42 ~ "33-42",
                            age > 42 ~ "43+"))

# data.table way
groupgendercts <- train[,list(gender, age, agecat = case_when(age <= 23 ~ "23-",
                            age > 23 & age <= 26 ~ "24-26",
                            age > 26 & age <= 28 ~ "27-28",
                            age > 28 & age <= 32 ~ "29-32",
                            age > 32 & age <= 42 ~ "33-42",
                            age > 42 ~ "43+"))]

ggplot(data = groupgendercts) +
  geom_mosaic(aes(x = product(gender, agecat), fill = gender)) +
  labs(x = "Age", y = "Gender", main = "App Usage by Age and Gender")
```


Relationship of Phonebrand with Gender & Age
```{r}
unique(train[which(train$group == 'M39+')]$phone_brand)
```
```{r}
# Function to count the number of different brands each group category uses
m39.lenova<-dim(train[which(train$group=='M39+'& train$phone_brand=='??????')])[1]
phone_count=function(group) {
  lenova<-dim(train[which(train$group==group& train$phone_brand=='lenova')])[1]
  samsung<-dim(train[which(train$group==group & train$phone_brand=='samsung')])[1]
  ctyon<-dim(train[which(train$group==group & train$phone_brand=='ctyon')])[1]
  coolpad<-dim(train[which(train$group==group & train$phone_brand=='coolpad')])[1]
  vivo<-dim(train[which(train$group==group & train$phone_brand=='vivo')])[1]
  huawei<-dim(train[which(train$group==group & train$phone_brand=='huawei')])[1]
  gionee<-dim(train[which(train$group==group & train$phone_brand=='gionee')])[1]
  le<-dim(train[which(train$group==group & train$phone_brand=='le')])[1]
  meizu<-dim(train[which(train$group==group & train$phone_brand=='meizu')])[1]
  mi<-dim(train[which(train$group==group & train$phone_brand=='mi')])[1]
  meitu<-dim(train[which(train$group==group & train$phone_brand=='meitu')])[1]
  smartisan<-dim(train[which(train$group==group & train$phone_brand=='smartisan')])[1]
  yitong<-dim(train[which(train$group==group & train$phone_brand=='yitong')])[1]
  zte<-dim(train[which(train$group==group & train$phone_brand=='zte')])[1]
  koobee<-dim(train[which(train$group==group & train$phone_brand=='koobee')])[1]
  doov<-dim(train[which(train$group==group & train$phone_brand=='doov')])[1]
  nubia<-dim(train[which(train$group==group & train$phone_brand=='nubia')])[1]
  na<-dim(train[which(train$group==group & is.na(train$phone_brand))])[1]
  group_phone_count<-data.frame('phone_brand'=c('lenova','samsung', 'ctyon', 'coolpad', 'vivo', 'huawei', 'gionee', 'le','meizu','smartisan','yitong', 'zte', 'koobee', 'doov','nubia', 'na'), 'count'=c(lenova, samsung, ctyon, coolpad, vivo, huawei, gionee, le, meizu, smartisan, yitong, zte, koobee, doov, nubia, na))
  return(group_phone_count)
}

# Simpler with dplyr
# Phone brand count by group
group_phone_count <- train %>%
  group_by(group, phone_brand) %>%
  dplyr::summarise(count = n()) %>%
  arrange(desc(count), .by_group = TRUE)

phone_count <- train %>%
  group_by(group) %>%
  dplyr::summarise(count = n()) %>%
  arrange(desc(count))
```

```{r results='asis', echo=FALSE}
kable(phone_count, caption = 'Phone Devices Count') %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "responsive", "condensed"), full_width = F)

kable(group_phone_count, caption = 'Phone Devices By Group') %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "responsive"), full_width = F) %>%
  group_rows("F23-", 1, 6) %>%
  group_rows("F24-26", 7, 11) %>%
  group_rows("F27-28", 12, 15) %>%
  group_rows("F29-32", 16, 21) %>%
  group_rows("F33-42", 22, 27) %>%
  group_rows("F43+", 28, 32) %>%
  group_rows("M22-", 33, 38) %>%
  group_rows("M23-26", 39, 48) %>%
  group_rows("M27-28", 49, 56) %>%
  group_rows("M29-31", 57, 67) %>%
  group_rows("M32-38", 68, 77) %>%
  group_rows("M39+", 78, 85)
```

```{r fig.width=13}
phonebrandmf <- train %>%
  mutate(mf = ifelse(grepl("M", train$group) == TRUE, "Male", "Female")) %>%
  filter(is.na(phone_brand) == FALSE) %>%
  select(group, mf, phone_brand)

groupgendercts <- train[is.na(phone_brand) == FALSE,list(gender, age, agecat = case_when(age <= 23 ~ "23-",
                            age > 23 & age <= 26 ~ "24-26",
                            age > 26 & age <= 28 ~ "27-28",
                            age > 28 & age <= 32 ~ "29-32",
                            age > 32 & age <= 42 ~ "33-42",
                            age > 42 ~ "43+"), phone_brand)]

p <- ggplot(data=groupgendercts) +
    geom_mosaic(aes(x=product(phone_brand, agecat), conds=product(gender), fill = gender))
ggplotly(p)

z <- ggplot(data=groupgendercts) +
  geom_mosaic(aes(x=product(phone_brand, agecat), conds=product(gender), fill = gender)) +
  facet_grid(gender~.)
ggplotly(z)
```

```{r}
ggplot(data = groupgendercts) +
  geom_mosaic(aes(x = product(gender, agecat), fill = gender)) +
  labs(x = "Age", y = "Gender", main = "App Usage by Age and Gender")
```

Map of the location data
```{r eval=FALSE}
locations <- train %>%
  select(longitude, latitude) %>%
  filter(longitude != 1 & longitude != 0 & latitude !=1 & latitude != 0)
box <- make_bbox(lon = locations$longitude, lat = locations$latitude, f = .1)

map <- get_map(location = box, maptype = 'terrain', source = 'google')

p <- ggmap(map)
p + geom_point(data = locations, mapping = aes(x = longitude, y = latitude), color = "red")
```


Most events occurred in the China area